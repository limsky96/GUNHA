<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>넷플릭스</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>

<body>
  <!-- 헤더 -->

  <section>
    <div class="w-50 ms-5 mt-5">
      <div id="title">
        <h1>비밀번호 변경</h1>
      </div>
      <div id="title-detail">
        <h3>6자 이상의 고유한 비밀번호로 계정을 보호하세요.</h3>
      </div>

      <form class="needs-validation" novalidate>
        <div>
          <input type="password" id="old-password" name="old-password" placeholder="기존 비밀번호" required />
          <div class="invalid-feedback">
            비밀 번호를 최소 6자 입력해주세요.
          </div>
        </div>
        <div>
          <input type="password" id="new-password" name="new-password" minlength="6" placeholder="새 비밀번호(6~60자)" required />
          <div class="invalid-feedback">
            새로운 번호를 입력해주세요.
          </div>
        </div>
        <div>
          <input type="password" id="new-password-repeat" placeholder="새 비밀번호를 다시 입력하세요." required />
          <div class="invalid-feedback">
            비밀번호가 다릅니다.
          </div>
        </div>
        <div class="hidden-place d-none">
          <input type="hidden" id="user-id" th:value="${#authentication.principal.username}">
        </div>
        <input class="btn btn-primary" type="submit" value="저장" />
        <input class="btn btn-secondary" type="button" onclick="location.href='/my/account'" value="취소" />
      </form>
    </div>
  </section>



  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    (function () {
      'use strict'

      const forms = document.querySelectorAll('.needs-validation')
      const oldPassword = document.querySelector("#old-password")
      const newPassword = document.querySelector("#new-password");
      const newPasswordRepeat = document.querySelector("#new-password-repeat");
      const userId = document.querySelector("#user-id");
      newPassword.addEventListener("keyup", isEqualPassword)
      newPasswordRepeat.addEventListener("keyup", isEqualPassword)
      Array.prototype.slice.call(forms)
        .forEach(function (form) {
          form.addEventListener('submit', async function (event) {
            event.preventDefault();
              event.stopPropagation();
            if (newPassword.value !== newPasswordRepeat.value) {


            } else if (!form.checkValidity()) {
              
            }else{
              
              const requestBody = {
                "userId": userId.value,
                "oldPassword": oldPassword.value,
                "newPassword": newPassword.value,
              };
              const response = await axios.patch("/my/password", requestBody, {
                headers:{
                  "Content-type": "application/json"
                }
              })
              console.log(response);
              const {data, status} = response;
              const {message, code} = data;
              if(code === 0){
                alert(message);
                location.href="/my/account";
              } else{
                alert(message);
              }
              
            }

            form.classList.add('was-validated')
          }, false)
        })
    })()
    function isEqualPassword (){
      const newPassword = document.querySelector("#new-password");
      const newPasswordRepeat = document.querySelector("#new-password-repeat");
      if(newPasswordRepeat.value === ""){
        return false;
      } else if (newPassword.value !== newPasswordRepeat.value) {
        newPasswordRepeat.nextElementSibling.style.display = 'block'
        return false;
      } else{ 
        newPasswordRepeat.nextElementSibling.style.display = 'none'
        return true;
      }
    }
  </script>

</body>

</html>